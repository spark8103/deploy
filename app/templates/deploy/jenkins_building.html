{% extends "base.html" %}
{% from "_formhelpers.html" import render_field %}

{% block title %}{{ config['SITE_NAME'] }} - Jenkins Building{% endblock %}

{% block page_content %}
<div class="page-header">
    <h2>Jenkins Building</h2>
</div>

<div class="col-md-10">
    <form id="jenkins_building" class="form-horizontal" action="{{ url_for('deploy.jenkins_building') }}" method="POST">
        {{ form.csrf_token }}
        {{ render_field(form.job) }}
        <div class="form-group">
            <div class="col-sm-4">
            </div>
            <div class="col-sm-8">
                <button type="submit" class="btn btn-primary">submit</button>&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="reset" class="btn btn-danger">reset</button>
            </div>
        </div>
    </form>
</div>

<div class="col-md-12">
    <hr />
</div>

<div class="col-md-12">
    <div class="panel panel-info">
        <div class="panel-heading">Result</div>
        <div class="panel-body">
            <p id="result"></p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/PerfectLoad.js') }}"></script>

<script>
$( "#jenkins_building" ).submit(function(event) {
    var job_name = $('#job').val()
    $('#result').empty();
    $('#result').append("<img src=\"/static/images/loading.gif\" /><span class=\"text-warning\"><strong>" + job_name + "</strong> is Building...</sparn>");
    $.ajax({
        url: "{{ url_for('deploy.jenkins_building') }}",
        data: {
            'csrf_token': $('#csrf_token').val(),
            'job': job_name
        },
        type: "POST",
        dataType:"json"
    }).done(function(data){
        //$.bootstrapLoading.end();
        if(data['result'] == 'SUCCESS') {
            var revisions = data['revisions'];
            var html2 = '';
            for (i in revisions) {
                html2 += "<p class=\"text-primary\">SVN: <strong>" + revisions[i].module +
                    "</strong></p><p class=\"text-primary\">Version: <strong>" + revisions[i].revision + "</strong></p>";
            }
            var html = "<h4>Job: <mark>" + job_name + "</mark>    BuildNumber: <mark>" + data['build_number'] + "</mark></h4><hr />" + html2;
        }else{
            html = "<h4>Job: <mark>" + job_name + "</mark>    BuildNumber: <mark>" + data['build_number'] +
                "</mark></h4><hr /><p class=\"text-danger\"><strong>Building is ERROR!</strong></p>";
        }
        $('#result').empty();
        $('#result').append(html);
    });
  event.preventDefault();
});
</script>
{% endblock %}